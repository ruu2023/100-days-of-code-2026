<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Supabase REST CRUD (vanilla)</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 900px; margin: 24px auto; padding: 0 12px; }
    textarea { width: 100%; height: 140px; }
    input { width: 240px; }
    button { margin-right: 8px; }
    pre { background: #111; color: #eee; padding: 12px; overflow: auto; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
  </style>
</head>
<body>
  <h1>Supabase REST CRUD (vanilla JS)</h1>

  <div class="row">
    <label>date: <input id="date" value="2026-02-10" /></label>
    <button id="btnUpsert">Upsert</button>
    <button id="btnGet">Get (single)</button>
    <button id="btnList">List (range)</button>
    <button id="btnDelete">Delete</button>
  </div>

  <p>payload (json):</p>
  <textarea id="payload">
{
  "logs": ["[18:00] (20min) eee"],
  "diary": { "事実": "e", "発見": "a", "教訓": "d", "宣言": "a", "悩み": "c" }
}
  </textarea>

  <h3>result</h3>
  <pre id="out"></pre>

<script>
  // ★ここを自分の値に差し替え
  const SUPABASE_URL = "https://yzlqxmmocxckcugrpgmu.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_MKW83pfEsTv0kQSA1BCI9A_eSHA-AUi";

  // PostgREST base
  const REST = `${SUPABASE_URL}/rest/v1/daily_logs`;

  const out = (obj) => {
    document.getElementById("out").textContent =
      typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
  };

  const headers = (extra = {}) => ({
    "apikey": SUPABASE_ANON_KEY,
    "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
    "Content-Type": "application/json",
    ...extra,
  });

  const getDate = () => document.getElementById("date").value.trim();
  const getPayload = () => JSON.parse(document.getElementById("payload").value);

  async function handle(res) {
    const text = await res.text();
    const data = text ? (() => { try { return JSON.parse(text); } catch { return text; } })() : null;

    if (!res.ok) {
      throw new Error(`${res.status} ${res.statusText}\n${typeof data === "string" ? data : JSON.stringify(data, null, 2)}`);
    }
    return data;
  }

  // Upsert: 同じ date があれば上書き
  async function upsertDailyLog(date, payload) {
    // on_conflict=date を使う（date を unique にしてる前提）
    const url = `${REST}?on_conflict=date`;

    const res = await fetch(url, {
      method: "POST",
      headers: headers({
        "Prefer": "resolution=merge-duplicates,return=representation"
      }),
      body: JSON.stringify([{ date, payload }]), // 複数行insert形式
    });

    return handle(res);
  }

  // Get single by date
  async function getDailyLog(date) {
    const url = `${REST}?select=date,payload,created_at&date=eq.${encodeURIComponent(date)}`;
    const res = await fetch(url, { headers: headers() });
    const rows = await handle(res);
    return rows?.[0] ?? null;
  }

  // List range (YYYY-MM-DD)
  async function listDailyLogs(from, to) {
    const url = `${REST}?select=date,payload&date=gte.${from}&date=lte.${to}&order=date.desc`;
    const res = await fetch(url, { headers: headers() });
    return handle(res);
  }

  // Delete by date
  async function deleteDailyLog(date) {
    const url = `${REST}?date=eq.${encodeURIComponent(date)}`;
    const res = await fetch(url, {
      method: "DELETE",
      headers: headers({ "Prefer": "return=representation" }),
    });
    return handle(res);
  }

  document.getElementById("btnUpsert").onclick = async () => {
    try {
      out("loading...");
      const data = await upsertDailyLog(getDate(), getPayload());
      out(data);
    } catch (e) {
      out(String(e));
    }
  };

  document.getElementById("btnGet").onclick = async () => {
    try {
      out("loading...");
      const data = await getDailyLog(getDate());
      out(data);
    } catch (e) {
      out(String(e));
    }
  };

  document.getElementById("btnList").onclick = async () => {
    try {
      out("loading...");
      const data = await listDailyLogs("2026-02-01", "2026-02-28");
      out(data);
    } catch (e) {
      out(String(e));
    }
  };

  document.getElementById("btnDelete").onclick = async () => {
    try {
      out("loading...");
      const data = await deleteDailyLog(getDate());
      out(data);
    } catch (e) {
      out(String(e));
    }
  };
</script>
</body>
</html>
